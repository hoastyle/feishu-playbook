pipeline {
    agent any

    environment {
        FEISHU_APP_ID = credentials('feishu-app-id')
        FEISHU_APP_SECRET = credentials('feishu-app-secret')
        FEISHU_FOLDER_TOKEN = credentials('feishu-folder-token')
        DOCS_DIR = 'docs'
    }

    triggers {
        // Trigger on SCM changes
        pollSCM('H/15 * * * *')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup') {
            steps {
                sh '''
                    pip install --user requests python-dotenv
                    # Or install feishu-doc-tools package
                    # pip install --user feishu-doc-tools
                '''
            }
        }

        stage('Upload Documentation') {
            when {
                changeset "docs/**"
            }
            steps {
                sh '''
                    echo "üì§ Uploading documentation to Feishu..."
                    python /path/to/feishu-doc-tools/scripts/batch_create_docs.py \
                      --source-dir "${DOCS_DIR}" \
                      --recursive \
                      --parallel \
                      --workers 5 \
                      --folder-token "${FEISHU_FOLDER_TOKEN}"
                '''
            }
            post {
                success {
                    echo '‚úÖ Documentation uploaded successfully to Feishu!'
                }
                failure {
                    echo '‚ùå Documentation upload failed!'
                    mail to: 'team@example.com',
                         subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
                         body: "Documentation upload to Feishu failed. Check console output at ${env.BUILD_URL}"
                }
            }
        }

        stage('Upload API Documentation') {
            when {
                anyOf {
                    changeset "api/**/*.md"
                    changeset "openapi.yaml"
                }
            }
            steps {
                sh '''
                    echo "üì§ Uploading API documentation to Feishu..."
                    python /path/to/feishu-doc-tools/scripts/batch_create_docs.py \
                      --source-dir api \
                      --recursive \
                      --parallel \
                      --workers 5 \
                      --folder-token "${FEISHU_API_FOLDER_TOKEN}"
                '''
            }
        }

        stage('Verify Upload') {
            steps {
                sh '''
                    echo "üîç Verifying upload..."
                    # Add verification logic here
                '''
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        success {
            echo '‚ú® Pipeline completed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed!'
        }
    }
}
